<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„ë• RPG: ì„¸ìƒì„ êµ¬í•˜ëŠ” ìš©ì‚¬ë“¤</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Sans+KR:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
/* --- 1. CORE ENGINE & LAYOUT --- */
* { box-sizing: border-box; }

body {
    background-color: #202028;
    display: flex;
    flex-direction: column;
    align-items: center; 
    margin: 0;
    min-height: 100vh;
    padding: 40px 20px;
    font-family: 'DotGothic16', sans-serif;
    color: #fff;
}

/* Slide Container */
.slide-container {
    background-color: #2d2d3a;
    border: 4px solid #fff;
    border-radius: 8px;
    box-shadow: 
        0 0 0 4px #2d2d3a,
        0 0 0 8px #fff,
        0 20px 50px rgba(0,0,0,0.5);
    display: none; 
    flex-direction: column;
    height: 720px;
    width: 1280px;
    padding: 40px;
    position: relative;
    overflow: hidden;
    image-rendering: pixelated;
    margin-bottom: 40px;
    flex-shrink: 0; 
}
.slide-container.active { display: flex; }

/* CRT Effect */
.slide-container::after {
    content: " ";
    display: block;
    position: absolute;
    top: 0; left: 0; bottom: 0; right: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    z-index: 10;
    background-size: 100% 2px, 3px 100%;
    pointer-events: none;
}

/* --- 2. TYPOGRAPHY --- */
h1 { font-family: 'DotGothic16', sans-serif; font-size: 80px; color: #f1c40f; line-height: 1.2; text-shadow: 4px 4px 0 #000; margin: 0; }
h2 { font-family: 'DotGothic16', sans-serif; font-size: 48px; color: #2ecc71; margin-bottom: 30px; border-bottom: 4px dashed #fff; padding-bottom: 15px; display: inline-block; text-shadow: 2px 2px 0 #000; }
p, li { font-size: 24px; line-height: 1.6; text-shadow: 2px 2px 0 #000; }

/* --- 3. LOGIN UI --- */
#login-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    width: 100%;
    position: absolute;
    top: 0; left: 0;
    z-index: 100;
    background-color: #202028;
}

#login-screen {
    background-color: #000;
    border: 4px solid #f1c40f;
    width: 600px;
    padding: 40px;
    text-align: center;
    border-radius: 20px;
    box-shadow: 0 0 50px rgba(241, 196, 15, 0.3);
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.login-title { font-size: 40px; color: #f1c40f; margin-bottom: 20px; }
.login-input {
    background-color: #222;
    border: 2px solid #555;
    color: #fff;
    font-family: 'DotGothic16', sans-serif;
    font-size: 24px;
    padding: 15px;
    text-align: center;
    border-radius: 10px;
}
.login-input:focus { outline: none; border-color: #2ecc71; background-color: #333; }

.login-btn {
    background-color: #2ecc71;
    color: #000;
    font-size: 28px;
    padding: 15px;
    border: none;
    font-family: 'DotGothic16', sans-serif;
    cursor: pointer;
    box-shadow: 0 5px 0 #27ae60;
    border-radius: 10px;
    margin-top: 20px;
}
.login-btn:active { transform: translateY(5px); box-shadow: none; }
.login-btn:disabled { background-color: #555; color: #888; cursor: not-allowed; box-shadow: none; }

/* --- 4. GAME UI --- */
.skill-tree { display: flex; justify-content: space-between; gap: 20px; height: 80%; align-items: center; }
.skill-card {
    background-color: #34495e; border: 4px solid #fff; box-shadow: 8px 8px 0 #000;
    padding: 20px 15px; flex: 1; height: 450px;
    display: flex; flex-direction: column; align-items: center; text-align: center;
    transition: transform 0.2s;
}
.skill-card:hover { transform: translateY(-10px); background-color: #2c3e50; }
.skill-icon { width: 100px; height: 100px; background-color: #000; border: 4px solid #f1c40f; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; font-size: 40px; color: #f1c40f; }
.skill-key { font-family: 'Press Start 2P', cursive; color: #e67e22; font-size: 40px; margin-bottom: 10px; }
.skill-name { color: #2ecc71; font-size: 28px; margin-bottom: 10px; font-weight: bold; }
.skill-desc { font-size: 18px; color: #bdc3c7; }

.hud-layout { display: flex; gap: 40px; height: 100%; width: 100%; }
.hud-stats { flex: 1; background-color: rgba(0,0,0,0.3); border: 4px solid #fff; padding: 30px; display: flex; flex-direction: column; justify-content: center; }
.stat-row { margin-bottom: 25px; }
.stat-label { color: #f1c40f; font-size: 20px; margin-bottom: 8px; display: block; }
.stat-value { color: #fff; font-size: 24px; }
.quest-box { background-color: #2c3e50; border: 2px solid #e74c3c; padding: 15px; margin-top: 20px; }
.quest-title { color: #e74c3c; font-size: 18px; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px solid #e74c3c; padding-bottom: 5px; }

.app-screen {
    flex: 1.2; border: 4px solid #3498db; background-color: #1a1a1d;
    position: relative; display: flex; flex-direction: column; padding: 20px; overflow: hidden;
}
.app-header { font-family: 'Press Start 2P'; font-size: 16px; color: #3498db; margin-bottom: 15px; display: flex; justify-content: space-between; }
.player-info { font-size: 14px; color: #f1c40f; text-align: right; }

.pixel-input {
    background-color: #000; color: #fff; font-family: 'DotGothic16', sans-serif; font-size: 20px;
    border: 2px solid #555; padding: 10px; width: 100%; height: 100px; resize: none; margin-bottom: 10px;
}
.pixel-input:focus { outline: none; border-color: #f1c40f; }

.pixel-btn {
    background-color: #3498db; color: #fff; font-family: 'Press Start 2P'; font-size: 14px;
    border: 4px solid #fff; box-shadow: 4px 4px 0 #000; padding: 15px; cursor: pointer; width: 100%; margin-bottom: 15px; text-align: center;
}
.pixel-btn:hover { background-color: #2980b9; transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; }
.pixel-btn:active { transform: translate(4px, 4px); box-shadow: none; }
.pixel-btn.magic { background-color: #9b59b6; } 
.pixel-btn.fire { background-color: #e74c3c; } 

.result-box {
    background-color: #000; border: 2px solid #2ecc71; color: #2ecc71; padding: 15px; flex-grow: 1;
    font-family: 'DotGothic16', sans-serif; font-size: 20px; overflow-y: auto; white-space: pre-wrap;
}

.loading {
    display: none; color: #f1c40f; text-align: center; margin: 10px 0;
    font-family: 'Press Start 2P'; font-size: 12px; animation: blink 0.5s infinite;
}

.dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; height: 100%; overflow-y: auto; padding-right: 10px; }
.student-card { background-color: #222; border: 2px solid #555; padding: 15px; border-radius: 8px; position: relative; margin-bottom: 10px; }
.student-card.me { border-color: #f1c40f; background-color: #2c2c20; }
.student-header { display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px; font-size: 20px; color: #fff; }
.student-result { font-size: 16px; color: #ccc; line-height: 1.4; max-height: 100px; overflow-y: hidden; text-overflow: ellipsis; white-space: pre-wrap; }

.status-msg { color: #777; font-size: 14px; margin-top: 10px; }
.server-status {
    position: fixed; bottom: 30px; left: 30px; z-index: 999;
    font-family: 'Noto Sans KR', sans-serif; font-size: 14px; color: #2ecc71;
    display: flex; align-items: center; gap: 8px;
    background: rgba(0,0,0,0.7); padding: 8px 12px; border-radius: 20px;
}

.home-btn {
    position: fixed; bottom: 30px; right: 30px; z-index: 999;
    background-color: #e74c3c; color: #fff; border: 4px solid #fff; padding: 15px 20px;
    font-family: 'Noto Sans KR', sans-serif; font-weight: 700; cursor: pointer; box-shadow: 4px 4px 0 #000;
    display: none; font-size: 16px; align-items: center; gap: 10px; border-radius: 0;
}
.home-btn:hover { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; background-color: #c0392b; }
.home-btn:active { transform: translate(4px, 4px); box-shadow: none; }

.boss-mode .app-screen { border-color: #e74c3c; }
.boss-mode .app-header { color: #e74c3c; }
.boss-mode .result-box { border-color: #e74c3c; color: #e74c3c; }
.title-screen { text-align: center; }
.title-screen .subtitle { font-size: 32px; color: #fff; margin-top: 20px; background-color: #e74c3c; padding: 10px 30px; border: 4px solid #fff; box-shadow: 8px 8px 0 #000; animation: blink 1.5s infinite; }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    </style>
</head>
<body>

<div id="server-status" class="server-status">
    <i class="fa-solid fa-circle-nodes"></i> ì„œë²„ ì—°ê²° ì¤‘...
</div>

<!-- 0. LOGIN SCREEN -->
<div id="login-wrapper">
    <div id="login-screen">
        <div class="login-title"><i class="fa-solid fa-dungeon"></i> ìºë¦­í„° ìƒì„±</div>
        <p style="font-size: 18px; color: #aaa; margin-bottom: 30px;">ë„ë• RPG ì„œë²„ì— ì ‘ì†í•©ë‹ˆë‹¤.</p>
        
        <input type="text" id="student-id" class="login-input" placeholder="í•™ë²ˆ (ì˜ˆ: 10101)">
        <input type="text" id="student-name" class="login-input" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)">
        
        <button id="login-btn" class="login-btn" onclick="Frontend.startLogin()">ì ‘ì†í•˜ê¸° (CONNECT)</button>
        <div id="login-status" class="status-msg"></div>
    </div>
</div>

<button id="home-btn" class="home-btn" onclick="Frontend.goHome()">
    <i class="fa-solid fa-rotate-left"></i> ì²˜ìŒìœ¼ë¡œ
</button>

<!-- Slide 1: Title -->
<div class="slide-container title-screen" id="slide-title">
    <p style="color: #f1c40f; font-family: 'Press Start 2P'; margin-bottom: 20px;">INSERT COIN</p>
    <h1>ë„ë• RPG<br><span style="font-size: 50px; color: #fff;">ì„¸ìƒì„ êµ¬í•˜ëŠ” ìš©ì‚¬ë“¤</span></h1>
    <div class="subtitle">D-SEL ì§ˆë¬¸ ê¸°ë°˜ [D.I.T.T.O.] ì–´ë“œë²¤ì²˜</div>
    <div style="margin-top: 60px;">
        <i class="fa-solid fa-gamepad" style="font-size: 60px; color: #fff; animation: blink 2s infinite;"></i>
    </div>
    <div style="margin-top: 30px; font-size: 20px; color: #2ecc71;">
        Player: <span id="display-player-name">Unknown</span>
    </div>
</div>

<!-- Slide 2: Skill Tree -->
<div class="slide-container">
    <h2><i class="fa-solid fa-book-skull"></i> íŠœí† ë¦¬ì–¼: ê¸°ë³¸ ìŠ¤í‚¬</h2>
    <div class="skill-tree">
        <div class="skill-card">
            <div class="skill-icon"><i class="fa-solid fa-magnifying-glass"></i></div>
            <div class="skill-key">D</div>
            <div class="skill-name">ë°ì´í„° ìŠ¤ìº”<br>(ì°¾ë‹¤)</div>
            <div class="skill-desc">ë””ì§€í„¸ ë„êµ¬ë¡œ<br>ìˆ¨ê²¨ì§„ ì§„ì‹¤ì„<br>ì°¾ì•„ë‚¸ë‹¤</div>
        </div>
        <div class="skill-card">
            <div class="skill-icon"><i class="fa-solid fa-heart-pulse"></i></div>
            <div class="skill-key">I</div>
            <div class="skill-name">ë§ˆë‚˜ ì¶©ì „<br>(í’ˆë‹¤)</div>
            <div class="skill-desc">ë°°ì›€ì„ ë‚´ë©´ì˜<br>ì—ë„ˆì§€ë¡œ<br>ë³€í™˜í•œë‹¤</div>
        </div>
        <div class="skill-card">
            <div class="skill-icon"><i class="fa-solid fa-users"></i></div>
            <div class="skill-key">T</div>
            <div class="skill-name">íŒŒí‹° ë§í¬<br>(ë‚˜ëˆ„ë‹¤)</div>
            <div class="skill-desc">ë™ë£Œë“¤ê³¼<br>ì •ì‹ ì„ ì—°ê²°í•˜ì—¬<br>í˜‘ë ¥í•œë‹¤</div>
        </div>
        <div class="skill-card">
            <div class="skill-icon"><i class="fa-solid fa-bolt"></i></div>
            <div class="skill-key">T</div>
            <div class="skill-name">ìŠ¤í‚¬ ì‹œì „<br>(ì‡ë‹¤)</div>
            <div class="skill-desc">í˜„ì‹¤ ì„¸ê³„ì—<br>ì§ì ‘ ë§ˆë²•ì„<br>ì‚¬ìš©í•œë‹¤</div>
        </div>
        <div class="skill-card">
            <div class="skill-icon"><i class="fa-solid fa-globe"></i></div>
            <div class="skill-key">O</div>
            <div class="skill-name">ì›”ë“œ ì²´ì¸ì§€<br>(í¼ì¹˜ë‹¤)</div>
            <div class="skill-desc">ì„¸ìƒì„ ë°”ê¾¸ëŠ”<br>ê¶ê·¹ê¸°ë¥¼<br>ì‹œì „í•œë‹¤</div>
        </div>
    </div>
</div>

<!-- Slide 3: Stage 1 -->
<div class="slide-container">
    <h2>STAGE 1: ìºë¦­í„° ìƒì„± (ìì•„ì„±ì°°) âœ¨</h2>
    <div class="hud-layout">
        <div class="hud-stats">
            <div class="stat-row">
                <span class="stat-label">â–¶ MISSION OBJECTIVE</span>
                <span class="stat-value">"AIë¡œ ë‚˜ë§Œì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ë¼"</span>
            </div>
            <div class="quest-box">
                <div class="quest-title">MAIN QUEST</div>
                <p style="font-size: 20px; color: #fff;">ë‚˜ì˜ ê°•ì /ì·¨í–¥ì„ ì…ë ¥í•˜ê³ <br>RPG ì§ì—…ê³¼ ìŠ¤íƒ¯ì„ í™•ì¸í•˜ì„¸ìš”.</p>
            </div>
        </div>
        <div class="app-screen">
            <div class="app-header">
                <span>SOUL SCANNER v1.0</span>
                <span class="player-info" id="p-info-1"></span>
            </div>
            <textarea id="input-stage1" class="pixel-input" placeholder="ì˜ˆ: ë‚˜ëŠ” ì¶•êµ¬ë¥¼ ì¢‹ì•„í•˜ê³ , ì¹œêµ¬ ê³ ë¯¼ ë“¤ì–´ì£¼ëŠ” ê±¸ ì˜í•´."></textarea>
            <button onclick="Frontend.runStage1()" class="pixel-btn">ìŠ¤ìº” ì‹œì‘ (SCAN)</button>
            <div id="loading-stage1" class="loading">ANALYZING SOUL DATA...</div>
            <div id="result-stage1" class="result-box">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
        </div>
    </div>
</div>

<!-- Slide 4: Stage 2 -->
<div class="slide-container">
    <h2>STAGE 2: ê¸¸ë“œ ê²°ì„± (ê´€ê³„ ê¸°ìˆ ) âœ¨</h2>
    <div class="hud-layout">
        <div class="app-screen">
            <div class="app-header">
                <span>HEART TRANSLATOR</span>
                <span class="player-info" id="p-info-2"></span>
            </div>
            <textarea id="input-stage2" class="pixel-input" placeholder="ì˜ˆ: ì•¼, ë„ˆ ì™œ ì´ë ‡ê²Œ ëŠ¦ì—ˆì–´? ì§œì¦ë‚˜ê²Œ."></textarea>
            <button onclick="Frontend.runStage2()" class="pixel-btn magic">ë”°ëœ»í•œ ë§ˆë²• ì‹œì „ (CAST)</button>
            <div id="loading-stage2" class="loading">CONVERTING TO LOVE...</div>
            <div id="result-stage2" class="result-box">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
        </div>
        <div class="hud-stats">
            <div class="stat-row">
                <span class="stat-label">â–¶ MISSION OBJECTIVE</span>
                <span class="stat-value">"ì°¨ê°€ìš´ ë§ì„ ë”°ëœ»í•˜ê²Œ ë°”ê¿”ë¼"</span>
            </div>
            <div class="quest-box" style="border-color: #f39c12;">
                <div class="quest-title" style="color: #f39c12;">CO-OP QUEST</div>
                <p style="font-size: 20px; color: #fff;">ê³µê²©ì ì¸ ì–¸ì–´ë¥¼<br>ë¹„í­ë ¥ ëŒ€í™”(NVC)ë¡œ ë²ˆì—­í•˜ì„¸ìš”.</p>
            </div>
        </div>
    </div>
</div>

<!-- Slide 5: Stage 3 -->
<div class="slide-container boss-mode">
    <h2 style="color: #e74c3c;">FINAL STAGE: ìš°ë¦¬ ë™ë„¤ ë³´ìŠ¤ ë ˆì´ë“œ âœ¨</h2>
    <div class="hud-layout">
        <div class="hud-stats">
            <div class="stat-row">
                <span class="stat-label">â–¶ WARNING !!</span>
                <span class="stat-value">ì§€ì—­ ì‚¬íšŒ ë¬¸ì œê°€ ë°œê²¬ë¨!</span>
            </div>
            <div class="quest-box" style="background-color: #3e2723;">
                <div class="quest-title">ULTIMATE SKILL</div>
                <p style="font-size: 20px; color: #fff;">ë¬¸ì œì ì„ ì…ë ¥í•˜ê³ <br>ê°•ë ¥í•œ ì„ ê±° ê³µì•½(í•„ì‚´ê¸°)ì„<br>ìƒì„±í•˜ì„¸ìš”.</p>
            </div>
        </div>
        <div class="app-screen">
            <div class="app-header">
                <span>MANIFESTO GENERATOR</span>
                <span class="player-info" id="p-info-3"></span>
            </div>
            <textarea id="input-stage3" class="pixel-input" placeholder="ì˜ˆ: í•™êµ ì• ê³¨ëª©ê¸¸ì— ì“°ë ˆê¸°ê°€ ë„ˆë¬´ ë§ì•„ì„œ ëƒ„ìƒˆê°€ ë‚˜ìš”."></textarea>
            <button onclick="Frontend.runStage3()" class="pixel-btn fire">ê¶ê·¹ê¸° ì‚¬ìš© (GENERATE)</button>
            <div id="loading-stage3" class="loading">CHARGING ULTIMATE...</div>
            <div id="result-stage3" class="result-box">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
        </div>
    </div>
</div>

<!-- Slide 6: Dashboard -->
<div class="slide-container" style="background-color: #111;">
    <h2><i class="fa-solid fa-trophy"></i> ëª…ì˜ˆì˜ ì „ë‹¹ (Real-time DB)</h2>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <div style="color: #aaa; font-size: 14px;">* Backend DBì™€ ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘</div>
        <button onclick="BackendService.resetDB()" style="background: #333; color: #555; border: 1px solid #555; cursor: pointer; padding: 5px 10px;">[ADMIN] DB ë¦¬ì…‹</button>
    </div>
    <div class="dashboard-grid" id="class-dashboard">
        <div style="color: #777; padding: 20px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</div>

<!-- MODULE: FIREBASE (v10.13.1 Stable) -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // 1. Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAOgLnbvTn8tvxJkXo6uucm1Kh86TjEGX4",
      authDomain: "moral-rpg-class.firebaseapp.com",
      projectId: "moral-rpg-class",
      storageBucket: "moral-rpg-class.firebasestorage.app",
      messagingSenderId: "699908221561",
      appId: "1:699908221561:web:5d0e60b524ab9d00aa02a8",
      measurementId: "G-HL3TE9C0RM"
    };
    const appId = 'moral-rpg-class-2024';
    const geminiApiKey = "AIzaSyD7NVKCHQWj5P9m7WV-gPnHveqLFFZUekM";

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ==========================================================
    // [BACKEND SERVICE]
    // ==========================================================
    const BackendService = {
        currentUser: null,
        currentStudentId: null,
        currentName: null,
        isOfflineMode: false, 

        init: async () => {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.warn("Auth Failed:", e);
                BackendService.isOfflineMode = true;
                Frontend.updateServerStatus("âš ï¸ ì˜¤í”„ë¼ì¸ ëª¨ë“œ", "orange");
                document.getElementById('login-btn').disabled = false;
                const statusDiv = document.getElementById('login-status');
                if(statusDiv) statusDiv.innerText = "ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì§„í–‰)";
            }
        },

        setupAuthListener: (callback) => {
            onAuthStateChanged(auth, (user) => {
                BackendService.currentUser = user;
                if (user) {
                    BackendService.isOfflineMode = false;
                    Frontend.updateServerStatus("ğŸŸ¢ ì„œë²„ ì—°ê²°ë¨", "#2ecc71");
                    callback(true);
                } else {
                    if (BackendService.isOfflineMode) callback(true);
                    else {
                        Frontend.updateServerStatus("ğŸ”´ ì—°ê²° ëŠê¹€", "red");
                        callback(false);
                    }
                }
            });
        },

        // ë¡œê·¸ì¸ ì²˜ë¦¬ (DB ì €ì¥ ì‹œë„í•˜ë˜, 3ì´ˆ ì´ìƒ ê±¸ë¦¬ë©´ ë¬´ì‹œí•˜ê³  ì§„í–‰)
        loginUser: async (id, name) => {
            BackendService.currentStudentId = id;
            BackendService.currentName = name;

            if (BackendService.isOfflineMode) return true;

            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'rpg_users', id);
            const data = { studentId: id, name: name, lastLogin: new Date().toISOString() };

            // íƒ€ì„ì•„ì›ƒ ë ˆì´ìŠ¤: DB ì €ì¥ì´ 3ì´ˆ ë‚´ì— ì•ˆ ë˜ë©´ ê·¸ëƒ¥ ì„±ê³µ ì²˜ë¦¬í•˜ê³  ë„˜ì–´ê°
            const savePromise = setDoc(userDocRef, data, { merge: true });
            const timeoutPromise = new Promise(resolve => setTimeout(() => resolve("TIMEOUT"), 3000));

            try {
                await Promise.race([savePromise, timeoutPromise]);
                return true; 
            } catch (e) {
                console.error("DB Save Error:", e);
                return true; // ì—ëŸ¬ë‚˜ë„ ì§„í–‰
            }
        },

        saveStageResult: async (stageKey, content) => {
            if (BackendService.isOfflineMode || !BackendService.currentStudentId) return;
            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'rpg_users', BackendService.currentStudentId);
            setDoc(userDocRef, { [stageKey]: content }, { merge: true }).catch(e => console.error(e));
        },

        subscribeToDashboard: (renderCallback) => {
            if (BackendService.isOfflineMode) { renderCallback([]); return; }
            const usersCol = collection(db, 'artifacts', appId, 'public', 'data', 'rpg_users');
            onSnapshot(usersCol, (snapshot) => {
                const users = [];
                snapshot.forEach(doc => users.push(doc.data()));
                renderCallback(users);
            }, (e) => console.error(e));
        },

        resetDB: async () => {
            if (BackendService.isOfflineMode) return alert("ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤.");
            if(!confirm("ì „ì²´ ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const usersCol = collection(db, 'artifacts', appId, 'public', 'data', 'rpg_users');
            const snapshot = await getDocs(usersCol);
            snapshot.forEach(d => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rpg_users', d.id)));
            alert("ì‚­ì œ ì™„ë£Œ");
        }
    };

    // ==========================================================
    // [FRONTEND CONTROLLER]
    // ==========================================================
    const Frontend = {
        init: () => {
            BackendService.init();
            BackendService.setupAuthListener((isReady) => {
                const btn = document.getElementById('login-btn');
                const status = document.getElementById('login-status');
                if(isReady) {
                    btn.disabled = false;
                    status.innerText = "ì„œë²„ ì¤€ë¹„ ì™„ë£Œ. ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
                } else {
                    btn.disabled = true;
                    status.innerText = "ì„œë²„ ì—°ê²° ì¤‘...";
                }
            });
        },

        updateServerStatus: (msg, color) => {
            const el = document.getElementById('server-status');
            el.innerHTML = `<i class="fa-solid fa-circle-nodes"></i> ${msg}`;
            el.style.color = color;
        },

        startLogin: async () => {
            const id = document.getElementById('student-id').value.trim();
            const name = document.getElementById('student-name').value.trim();
            if(!id || !name) { alert("ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            const btn = document.getElementById('login-btn');
            btn.innerText = "ì ‘ì† ì¤‘...";
            btn.disabled = true;

            const success = await BackendService.loginUser(id, name);
            
            btn.innerText = "ì ‘ì†í•˜ê¸° (CONNECT)";
            btn.disabled = false;

            if(success) {
                document.getElementById('login-wrapper').style.display = 'none';
                document.querySelectorAll('.slide-container').forEach(el => el.classList.add('active'));
                document.getElementById('home-btn').style.display = 'flex';
                
                const display = `${id} ${name}`;
                document.getElementById('display-player-name').innerText = display;
                document.getElementById('p-info-1').innerText = `PLAYER: ${name}`;
                document.getElementById('p-info-2').innerText = `PLAYER: ${name}`;
                document.getElementById('p-info-3').innerText = `PLAYER: ${name}`;

                document.getElementById('slide-title').scrollIntoView({ behavior: 'smooth' });
                BackendService.subscribeToDashboard(Frontend.renderDashboard);
            }
        },

        goHome: () => {
            BackendService.currentStudentId = null;
            BackendService.currentName = null;
            document.getElementById('login-wrapper').style.display = 'flex';
            document.querySelectorAll('.slide-container').forEach(el => el.classList.remove('active'));
            document.getElementById('home-btn').style.display = 'none';
            window.scrollTo(0, 0);
        },

        callAI: async (prompt) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch(e) { return "AI í†µì‹  ì˜¤ë¥˜"; }
        },

        runStage1: async () => {
            const input = document.getElementById("input-stage1").value;
            if(!input) return alert("ì…ë ¥ê°’ì´ ì—†ìŠµë‹ˆë‹¤.");
            document.getElementById("loading-stage1").style.display = "block";
            const prompt = `ì‚¬ìš©ì(${BackendService.currentName})ì˜ ì…ë ¥: "${input}". ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ RPG ì§ì—…ê³¼ ëŠ¥ë ¥ì¹˜ë¥¼ ì°½ì˜ì ìœ¼ë¡œ ìƒì„±í•´ì¤˜.`;
            const result = await Frontend.callAI(prompt);
            document.getElementById("loading-stage1").style.display = "none";
            document.getElementById("result-stage1").innerText = result;
            BackendService.saveStageResult("stage1", result);
        },

        runStage2: async () => {
            const input = document.getElementById("input-stage2").value;
            if(!input) return alert("ì…ë ¥ê°’ì´ ì—†ìŠµë‹ˆë‹¤.");
            document.getElementById("loading-stage2").style.display = "block";
            const prompt = `ê³µê²©ì ì¸ ë§ "${input}"ì„ ë¹„í­ë ¥ ëŒ€í™”ë²•ìœ¼ë¡œ ë”°ëœ»í•˜ê²Œ ë°”ê¿”ì¤˜.`;
            const result = await Frontend.callAI(prompt);
            document.getElementById("loading-stage2").style.display = "none";
            document.getElementById("result-stage2").innerText = result;
            BackendService.saveStageResult("stage2", result);
        },

        runStage3: async () => {
            const input = document.getElementById("input-stage3").value;
            if(!input) return alert("ì…ë ¥ê°’ì´ ì—†ìŠµë‹ˆë‹¤.");
            document.getElementById("loading-stage3").style.display = "block";
            const prompt = `ì§€ì—­ì‚¬íšŒ ë¬¸ì œ "${input}" í•´ê²°ì„ ìœ„í•œ ì²­ì†Œë…„ ì„ ê±° ê³µì•½ ìŠ¬ë¡œê±´ê³¼ í–‰ë™ ê°•ë ¹ì„ ë§Œë“¤ì–´ì¤˜.`;
            const result = await Frontend.callAI(prompt);
            document.getElementById("loading-stage3").style.display = "none";
            document.getElementById("result-stage3").innerText = result;
            BackendService.saveStageResult("stage3", result);
        },

        renderDashboard: (users) => {
            const container = document.getElementById('class-dashboard');
            if(users.length === 0) { container.innerHTML = '<div style="color:#777; padding:20px;">ë°ì´í„° ì—†ìŒ</div>'; return; }
            users.sort((a, b) => (a.studentId === BackendService.currentStudentId) ? -1 : a.studentId.localeCompare(b.studentId));
            
            let html = '';
            users.forEach(u => {
                const isMe = u.studentId === BackendService.currentStudentId;
                let content = u.stage3 ? `[FINAL] ${u.stage3}` : (u.stage2 ? `[STAGE 2] ${u.stage2}` : (u.stage1 ? `[STAGE 1] ${u.stage1}` : "ëª¨í—˜ ì¤€ë¹„ ì¤‘..."));
                if(content.length > 80) content = content.substring(0, 80) + "...";
                html += `<div class="${isMe ? 'student-card me' : 'student-card'}"><div class="student-header"><span>${u.studentId} ${u.name} ${isMe?'(ë‚˜)':''}</span><i class="fa-solid ${isMe?'fa-star':'fa-user-astronaut'}"></i></div><div class="student-result">${content}</div></div>`;
            });
            container.innerHTML = html;
        }
    };

    window.Frontend = Frontend;
    window.BackendService = BackendService;
    Frontend.init();
</script>

</body>
</html>